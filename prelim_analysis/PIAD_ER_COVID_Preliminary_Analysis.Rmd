---
title: "PIAD Maternal ER, COVID-19 Experiences, and Infant Socioemotional Development: Preliminary Analysis"
author: "Isaac Cormier"
date: "11/03/2025"
output:
  html_document:
    self_contained: true
    code_download: yes
    code_folding: show
    theme:
        bslib: yes
    toc: true
    toc_depth: 5
---
```{css, echo = FALSE}
table caption {
  caption-side: top !important;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

# 1. Background

This report summarizes preliminary regression models examining whether maternal emotion dysregulation (DERS) and prenatal COVID-19 experiences (combined subjective and objective) are associated with BITSEA child socioemotional competence at 15, 24, and 35 months.

# 2. Packages and data

```{r define_pkgs_data}

packages <- c("haven", "here", "dplyr", "purrr", "broom", "knitr", "kableExtra", "ggplot2", "performance", "see", "report", "gt", "parameters")

if (!require("pacman")) install.packages("pacman")
pacman::p_load(char = packages, character.only = TRUE)

#read data
df <- read_sav(here("data", "PIAD_COVID_Preg_35M.sav")) %>% 
  rename(COVID_Comp_Total = AvgObjCOVID40rescale) %>%
        mutate(
                DERS_Total_15M_std = as.numeric(scale(DERS_Total_15M)),
                DERS_Total_24M_std = as.numeric(scale(DERS_Total_24M)),
                DERS_Total_35M_std = as.numeric(scale(DERS_Total_35M)),
                COVID_Comp_Total_std = as.numeric(scale(COVID_Comp_Total))
        )

#main variables
outcomes <- c(
  "BITSEA_Prob_Total_15M",
  "BITSEA_Prob_Total_24M",
  "BITSEA_Prob_Total_35M"
)
predictors <- c("DERS_Total_15M", "DERS_Total_24M", "DERS_Total_35M", "COVID_Comp_Total")
DERS_preds <- c("DERS_Total_15M", "DERS_Total_24M", "DERS_Total_35M")

createKable <- function(tbl, title = "My Title"){
  boundary_rows <- which(
    c(FALSE, tbl[[1]][-1] != tbl[[1]][-length(tbl[[1]])])
  )
  
  align_vec <- c("l", rep("r", ncol(tbl) - 1))
  
  kable(
    tbl,
    col.names = names(tbl),
    align     = align_vec,
    digits    = 4,        
    format    = "html",
    caption   = title
  ) %>%
    kable_styling(
      bootstrap_options = c("condensed", "bordered"),
      full_width        = FALSE,
      position          = "left"
    ) %>%
    column_spec(
      which(sapply(tbl, is.numeric)),
      width     = "60px",
      extra_css = "padding-left:6px; padding-right:6px;"
    ) %>% 
    row_spec(
      boundary_rows,
      extra_css = "border-top: 3px solid black;"
    ) %>%
        scroll_box(width = "1000px", height = "400px")
}
```

# 3. Check Missing Values

```{r missingVals}
missing <- df %>% 
  select(all_of(c(outcomes, predictors))) %>% 
  summarise(across(everything(), ~ sum(is.na(.))))

createKable(
  missing,
  title = "Number of missing values by Variable"
)
```

# 4. Visualize Relatonship between Variables
```{r visual_plots, fig.width=9, fig.height=5, fig.align='center'}

for (i in seq_along(outcomes)) {
  outcome_var <- outcomes[i]
  ders_var <- DERS_preds[i]
  p <- ggplot(df) +
          aes(x = COVID_Comp_Total, y = .data[[outcome_var]], colour = .data[[ders_var]]) +
          geom_point() +
          scale_color_gradient() +
          labs(
                  y = paste0(outcome_var),
                  x = "COVID-19 Experience Comp Score",
                  colour = paste0(ders_var),
                  title = paste0("Association between COVID-19 Experiences, ", ders_var, " and ", outcome_var)
          ) +
          theme_minimal()
  print(p)
  
}

```

# 4. Diagnostic plots and normality

Creates regression diagnsotic plots to check that asssumptions of normality are met before running the models.
Also runs Shapiro-Wilks Test of Normality (although it is important to interpret the results of this test alongside the Q-Q Plot). 

```{r diagnostics}
check_assumptions <- function(data, outcome, DERS_pred) {
        model <- lm(as.formula(paste0(outcome, " ~COVID_Comp_Total + ", DERS_pred)), data=data)
        #Save plot as png file
        outfile <- here("prelim_analysis", "plots", paste0(outcome, "_diagnostic_plot.png"))
        dir.create(dirname(outfile), showWarnings = FALSE, recursive = TRUE)
        png(outfile, width = 1200, height = 1200)
        par(mfrow = c(2,2))
        plot(model)
        dev.off()
        #Send plot to viewer
        par(mfrow = c(2,2))
        plot(model)
        print(check_model(model))
        
        #Print shaprio-wilk test results from residuals
        resid <- residuals(model)
        shapWilk <- shapiro.test(resid)
        print(shapWilk)
}
```
## Regression Diagnostics for BITSEA Total Composite Score at 15M

```{r 15M_diagnostic}
check_assumptions(df, "BITSEA_Comp_Total_15M", "DERS_Total_15M")
```

## Regression Diagnostics for BITSEA Total Composite Score at 24M

```{r 24M_diagnostic}
check_assumptions(df, "BITSEA_Comp_Total_24M", "DERS_Total_24M")
```

## Regression Diagnostics for BITSEA Total Composite Score at 35M

```{r 35M_diagnostic}
check_assumptions(df, "BITSEA_Comp_Total_35M", "DERS_Total_35M")
```


# 5. Run the Regression Models

For each timepoint (15M, 24M, and 35M), there are four models:

1) A main-effects model of the raw DERS_Total and COVID_Comp_Total at pregnancy on the BITSEA Problem Scale

2) A main-effects model of the standardized DERS_Total and COVID_Comp_Total at pregnancy on the BITSEA Problem Scale

3) An interaction effect model of the raw DERS_Total and COVID_Comp_Total at pregnancy on the BITSEA Problem Scale

4) An interaction effect model of the standardized DERS_Total and COVID_Comp_Total at pregnancy on the BITSEA Problem Scale
        
Model versions with standardized predictors were prepared below the raw models due to the value of centering the predictors of a model prior to running regression analysis (See Cohen et al.'s (2003) textbook "Applied multiple regression/correlation analysis for the behavioral sciences (3rd ed.)").

## a) Regression Results for BITSEA Total Composite Score at 15 Months

### i) Main-effects for 15M

```{r main_15}
mdl <- lm(BITSEA_Comp_Total_15M ~ COVID_Comp_Total + DERS_Total_15M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### ii) Standardized Main-effects for 15M
```{r stdmain_15}
mdl <- lm(BITSEA_Comp_Total_15M ~ COVID_Comp_Total_std + DERS_Total_15M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iii) Interaction-effects for 15M
```{r int_15}
mdl <- lm(BITSEA_Comp_Total_15M ~ COVID_Comp_Total * DERS_Total_15M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iv) Standardized interaction-effects for 15M

```{r stdint_15}
mdl <- lm(BITSEA_Comp_Total_15M ~ COVID_Comp_Total_std * DERS_Total_15M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

## b) Regression Results for BITSEA Total Composite Score at 24 Months

### i) Main-effects for 24M

```{r main_24}
mdl <- lm(BITSEA_Comp_Total_24M ~ COVID_Comp_Total + DERS_Total_24M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### ii) Standardized Main-effects for 24M
```{r stdmain_24}
mdl <- lm(BITSEA_Comp_Total_24M ~ COVID_Comp_Total_std + DERS_Total_24M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iii) Interaction-effects for 24M
```{r int_24}
mdl <- lm(BITSEA_Comp_Total_24M ~ COVID_Comp_Total * DERS_Total_24M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iv) Standardized interaction-effects for 24M

```{r stdint_24}
mdl <- lm(BITSEA_Comp_Total_24M ~ COVID_Comp_Total_std * DERS_Total_24M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

## c) Regression Results for BITSEA Total Composite Score at 35 Months

### i) Main-effects for 35M

```{r main_35}
mdl <- lm(BITSEA_Comp_Total_35M ~ COVID_Comp_Total + DERS_Total_35M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### ii) Standardized Main-effects for 35M
```{r stdmain_35}
mdl <- lm(BITSEA_Comp_Total_35M ~ COVID_Comp_Total_std + DERS_Total_35M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iii) Interaction-effects for 35M
```{r int_35}
mdl <- lm(BITSEA_Comp_Total_35M ~ COVID_Comp_Total * DERS_Total_35M, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

### iv) Standardized interaction-effects for 35M

```{r stdint_35}
mdl <- lm(BITSEA_Comp_Total_35M ~ COVID_Comp_Total_std * DERS_Total_35M_std, data=df)
print_html(model_parameters(mdl), summary = TRUE)
print_html(model_performance(mdl), summary = TRUE)

report <- report_text(mdl)
```
`r report`

